<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tomtop.member.mappers.message.MessageMapper">
  <resultMap id="BaseResultMap" type="com.tomtop.member.models.dto.Message" >
    <id column="iid" property="id" jdbcType="INTEGER" />
    <result column="iwebsiteid" property="websiteId" jdbcType="INTEGER" />
    <result column="isendid" property="sendId" jdbcType="INTEGER" />
    <result column="cfrom" property="from" jdbcType="VARCHAR" />
    <result column="csubject" property="subject" jdbcType="VARCHAR" />
    <result column="ccontent" property="content" jdbcType="VARCHAR" />
    <result column="itype" property="type" jdbcType="INTEGER" />
    <result column="isendmethod" property="sendMethod" jdbcType="INTEGER" />
    <result column="dcreatedate" property="createDate" jdbcType="TIMESTAMP" />
    <result column="t" property="table" jdbcType="VARCHAR" />
    <result column="istatus" property="status" jdbcType="INTEGER" />
    <result column="cemail" property="email" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="common-0" >
    iid, iwebsiteid, isendid, cfrom, csubject, ccontent, itype, isendmethod, dcreatedate,cemail
  </sql>
 
 <sql id="common-1">
	select a.iid as id,a.cfrom as from,a.csubject subject,a.dcreatedate createDate,a.istatus status,'b' as tab
	from t_message_broadcast a
	where a.istatus in(1,3) and iwebsiteid=#{siteId} and a.dcreatedate>=#{dmemberRegDate,jdbcType=TIMESTAMP} and a.iid not in
	(
	select ibroadcastid from t_message_info 
	where cemail=#{userId} and iwebsiteid=#{siteId} and ibroadcastid is not null
	)
 </sql>
 <sql id="common-2">
	select iid as id,cfrom as from,csubject subject,dcreatedate createDate,istatus status,'i' as tab
	from t_message_info d
	where d.istatus in(1,4) and cemail=#{userId} and iwebsiteid=#{siteId}
 </sql>
 
 <sql id="common-3">
	select a.iid as id,a.cfrom as from,a.csubject subject,a.dcreatedate createDate,a.istatus status,'b' as tab
	from t_message_broadcast a
	where a.istatus=3 and iwebsiteid=#{siteId} and a.dcreatedate>=#{dmemberRegDate,jdbcType=TIMESTAMP} and a.iid not in
	(
	select ibroadcastid from t_message_info 
	where cemail=#{userId} and iwebsiteid=#{siteId} and ibroadcastid is not null
	)
 </sql>
 <sql id="common-4">
	select iid as id,cfrom as from,csubject subject,dcreatedate createDate,istatus status,'i' as tab
	from t_message_info d
	where d.istatus = 4
	and cemail=#{userId} and iwebsiteid=#{siteId}
 </sql>
 
  
  <select id="getMyMessageTotal" resultType="int" parameterType="map">
  	select count(*) from
  	(
  		<include refid="common-1"></include>
		UNION ALL
		<include refid="common-2"></include>
  	)e
  	
  </select>
  
   <select id="getMyUnMessageTotal" resultType="int" parameterType="map">
  	select count(*) from
  	(
  		<include refid="common-3"></include>
		UNION ALL
		<include refid="common-4"></include>
  	)e
  	
  </select>
  
  <select id="getMyMessageForPage" resultType="com.tomtop.member.models.dto.MessageInfo"  parameterType="map">
    select * from
  	(
	<include refid="common-1"></include>
	UNION ALL
	<include refid="common-2"></include>
	) a 
	
	<if test="page != null and page != '' and pageSize != null and pageSize != '' ">
    	ORDER BY status,createDate desc limit ${pageSize} offset
		(${page}-1)*${pageSize}
    </if>
    
  </select>
  
  <update id="updateMessageStatus" parameterType="map">
  	update t_message_info
	set istatus=${status} 
	<where>
		<choose>
			<when test="id != null and id != '' ">
				iid = ${id}
			</when>
			<otherwise>
				<if test="broadcastId != null and broadcastId != '' ">
					ibroadcastid = ${ibroadcastid}
				</if>
				<if test="userId != null and userId != '' ">
					and cemail = #{userId}
				</if>
			</otherwise>
		</choose>
	</where>
  </update>

  
  <select id="isExisted" resultType="int" parameterType="map">
  	SELECT count(*) from t_message_info
	where 1=1
	<if test="broadcastId != null and broadcastId !='' ">
		and ibroadcastid = ${broadcastId}
	</if>
	<if test="userId != null and userId != '' ">
		and cemail = #{userId}
	</if>
	
  </select>
  
  <insert id="insert" parameterType="map">
  	insert into t_message_info(iwebsiteid, isendid, cfrom, csubject, ccontent, itype, isendmethod,istatus,cemail)
  	values(#{websiteId},${sendId},#{from},#{subject},#{content},${type},${sendMethod},${status},#{email})
  </insert>
  
</mapper>